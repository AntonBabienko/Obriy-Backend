# –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó –æ–±—Ä–æ–±–∫–∏ PDF

## ‚úÖ –©–æ –∑—Ä–æ–±–ª–µ–Ω–æ

### 1. Text Cleaning Service
**–§–∞–π–ª:** `backend/src/services/textCleaner.ts`

–ù–æ–≤–∏–π —Å–µ—Ä–≤—ñ—Å –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –≤–∏—Ç—è–≥–Ω—É—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç—É:
- –í–∏–¥–∞–ª—è—î null bytes —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ñ —Å–∏–º–≤–æ–ª–∏
- –ù–æ—Ä–º–∞–ª—ñ–∑—É—î –ø—Ä–æ–±—ñ–ª–∏ (–º–Ω–æ–∂–∏–Ω–Ω—ñ ‚Üí –æ–¥–∏–Ω)
- –ù–æ—Ä–º–∞–ª—ñ–∑—É—î –ø–µ—Ä–µ–Ω–æ—Å–∏ —Ä—è–¥–∫—ñ–≤
- –í–∏–¥–∞–ª—è—î –ø–æ—Ä–æ–∂–Ω—ñ —Ç–∞ –¥—É–∂–µ –∫–æ—Ä–æ—Ç–∫—ñ —Ä—è–¥–∫–∏
- –õ–æ–≥—É—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—á–∏—â–µ–Ω–Ω—è

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ó–º–µ–Ω—à–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É —Ç–µ–∫—Å—Ç—É –Ω–∞ 30-50% (4.9 –º–ª–Ω ‚Üí 2-3 –º–ª–Ω —Å–∏–º–≤–æ–ª—ñ–≤)

### 2. Text Chunking Service
**–§–∞–π–ª:** `backend/src/services/textChunker.ts`

–ù–æ–≤–∏–π —Å–µ—Ä–≤—ñ—Å –¥–ª—è —Ä–æ–∑–±–∏—Ç—Ç—è —Ç–µ–∫—Å—Ç—É –Ω–∞ —á–∞–Ω–∫–∏:
- –†–æ–∑–º—ñ—Ä —á–∞–Ω–∫—É: 3000 —Å–∏–º–≤–æ–ª—ñ–≤ (~750 —Ç–æ–∫–µ–Ω—ñ–≤)
- Overlap: 500 —Å–∏–º–≤–æ–ª—ñ–≤ (–¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É)
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ —Å–µ–º–ø–ª—é–≤–∞–Ω–Ω—è –¥–ª—è –¥—É–∂–µ –≤–µ–ª–∏–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤
- –û—Ü—ñ–Ω–∫–∞ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ —Ç–æ–∫–µ–Ω—ñ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–∫—Å—Ç —Ä–æ–∑–±–∏–≤–∞—î—Ç—å—Å—è –Ω–∞ —á–∞–Ω–∫–∏, —è–∫—ñ OpenAI –º–æ–∂–µ –æ–±—Ä–æ–±–∏—Ç–∏ (max 8192 —Ç–æ–∫–µ–Ω–∏)

### 3. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ FileProcessor
**–§–∞–π–ª:** `backend/src/services/fileProcessor.ts`

–û–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è textCleaner:
- –ó–∞–º—ñ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ–≥–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è null bytes —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è
- –ü–æ–∫—Ä–∞—â–µ–Ω–∞ —è–∫—ñ—Å—Ç—å –≤–∏—Ç—è–≥–Ω—É—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç—É

### 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è Embeddings Service
**–§–∞–π–ª:** `backend/src/services/embeddings.ts`

–û–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è textChunker:
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –Ω–æ–≤–∏–π chunking –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
- –ó–±–µ—Ä—ñ–≥–∞—î chunk_index –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö
- –û–Ω–æ–≤–ª—é—î chunks_count —Ç–∞ processing_status
- –û–±—Ä–æ–±–ª—è—î –ø–æ–º–∏–ª–∫–∏ —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î —ó—Ö –≤ –ë–î

### 5. Database Migration
**–§–∞–π–ª:** `backend/supabase/migrations/add_lecture_processing_status.sql`

–ù–æ–≤–∞ –º—ñ–≥—Ä–∞—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –æ–±—Ä–æ–±–∫–∏:
- `processing_status` - —Å—Ç–∞—Ç—É—Å –æ–±—Ä–æ–±–∫–∏ (pending, processing, completed, failed)
- `processing_error` - –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
- `chunks_count` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö —á–∞–Ω–∫—ñ–≤
- –Ü–Ω–¥–µ–∫—Å –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É

---

## üìã –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

### –ö—Ä–æ–∫ 1: –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é –ë–î

–í—ñ–¥–∫—Ä–∏–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor —ñ –≤–∏–∫–æ–Ω–∞–π—Ç–µ:

```sql
-- –î–æ–¥–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å –æ–±—Ä–æ–±–∫–∏ –ª–µ–∫—Ü—ñ–π
ALTER TABLE public.lectures 
ADD COLUMN IF NOT EXISTS processing_status TEXT DEFAULT 'completed',
ADD COLUMN IF NOT EXISTS processing_error TEXT,
ADD COLUMN IF NOT EXISTS chunks_count INTEGER DEFAULT 0;

-- –î–æ–¥–∞—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ
COMMENT ON COLUMN public.lectures.processing_status IS '–°—Ç–∞—Ç—É—Å –æ–±—Ä–æ–±–∫–∏: pending, processing, completed, failed';
COMMENT ON COLUMN public.lectures.processing_error IS '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É —è–∫—â–æ –æ–±—Ä–æ–±–∫–∞ –Ω–µ –≤–¥–∞–ª–∞—Å—è';
COMMENT ON COLUMN public.lectures.chunks_count IS '–ö—ñ–ª—å–∫—ñ—Å—Ç—å —á–∞–Ω–∫—ñ–≤ —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö –¥–ª—è embeddings';

-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É
CREATE INDEX IF NOT EXISTS idx_lectures_processing_status 
ON public.lectures(processing_status);

-- –û–Ω–æ–≤–∏—Ç–∏ —ñ—Å–Ω—É—é—á—ñ –∑–∞–ø–∏—Å–∏
UPDATE public.lectures 
SET processing_status = 'completed'
WHERE processing_status IS NULL;
```

### –ö—Ä–æ–∫ 2: –û–Ω–æ–≤–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é lecture_embeddings

–î–æ–¥–∞–π—Ç–µ –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —ñ–Ω–¥–µ–∫—Å—É —á–∞–Ω–∫—É:

```sql
-- –î–æ–¥–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å —á–∞–Ω–∫—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫—É
ALTER TABLE public.lecture_embeddings 
ADD COLUMN IF NOT EXISTS chunk_index INTEGER DEFAULT 0;

-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É —á–∞–Ω–∫—ñ–≤
CREATE INDEX IF NOT EXISTS idx_lecture_embeddings_chunk_index 
ON public.lecture_embeddings(lecture_id, chunk_index);
```

### –ö—Ä–æ–∫ 3: –£–≤—ñ–º–∫–Ω—É—Ç–∏ embeddings (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

–Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ embeddings, —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –∫–æ–¥ –≤ `backend/src/routes/lecture.routes.ts`:

```typescript
// –ó–Ω–∞–π–¥—ñ—Ç—å —Ü–µ–π –±–ª–æ–∫ (—Ä—è–¥–æ–∫ ~130):
// –¢–ò–ú–ß–ê–°–û–í–û –í–ò–ú–ö–ù–ï–ù–û: Generate embeddings in background
console.log('[Lecture Upload] Embeddings generation temporarily disabled');

// –Ü –∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞:
if (extractedContent && extractedContent.length > 0) {
    console.log('[Lecture Upload] Starting embeddings generation in background...');
    setImmediate(() => {
        generateEmbeddings(lecture.id, extractedContent).catch((err) => {
            console.error('[Lecture Upload] Error generating embeddings:', err);
        });
    });
} else {
    console.log('[Lecture Upload] No content to generate embeddings from');
}
```

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –¢–µ—Å—Ç 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ text cleaning

–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ç–æ–π —Å–∞–º–∏–π PDF (3.58 MB) —ñ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏:

```
[TextCleaner] Starting cleaning, input length: 4952772
[TextCleaner] Cleaning complete:
[TextCleaner]   Original: 4952772 chars
[TextCleaner]   Cleaned: 2500000 chars  <-- –û—á—ñ–∫—É—î—Ç—å—Å—è –∑–º–µ–Ω—à–µ–Ω–Ω—è
[TextCleaner]   Reduction: 49.5%
```

### –¢–µ—Å—Ç 2: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ chunking (—è–∫—â–æ embeddings —É–≤—ñ–º–∫–Ω–µ–Ω—ñ)

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥–∏ embeddings:

```
[TextChunker] Chunking text: 2500000 chars
[TextChunker] Chunk size: 3000, Overlap: 500
[TextChunker] Created 1000 chunks
[TextChunker] Avg tokens per chunk: 750
[Embeddings] Total chunks: 1000 for lecture xxx
[Embeddings] Processing 150 chunks (2500000 chars total)  <-- –°–µ–º–ø–ª—é–≤–∞–Ω–Ω—è
```

### –¢–µ—Å—Ç 3: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–∞–º'—è—Ç—ñ

–ú–æ–Ω—ñ—Ç–æ—Ä—Ç–µ —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è –ø–∞–º'—è—Ç—ñ –ø—ñ–¥ —á–∞—Å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:

```
[FileProcessor] Memory delta: 56.69 MB  <-- –ú–∞—î –∑–∞–ª–∏—à–∏—Ç–∏—Å—å ~50-60 MB
```

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

### –î–æ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:
- –†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É: 4.9 –º–ª–Ω —Å–∏–º–≤–æ–ª—ñ–≤
- Embeddings: –í–ò–ú–ö–ù–ï–ù–Ü (–Ω–µ –º–æ–∂—É—Ç—å –æ–±—Ä–æ–±–∏—Ç–∏)
- –ß–∞—Å –æ–±—Ä–æ–±–∫–∏: 3-4 —Å–µ–∫—É–Ω–¥–∏
- –ü–∞–º'—è—Ç—å: +56 MB (16x —Ä–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É)

### –ü—ñ—Å–ª—è –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:
- –†–æ–∑–º—ñ—Ä —Ç–µ–∫—Å—Ç—É: ~2-3 –º–ª–Ω —Å–∏–º–≤–æ–ª—ñ–≤ (–∑–º–µ–Ω—à–µ–Ω–Ω—è 40-50%)
- Embeddings: –ü–†–ê–¶–Æ–Æ–¢–¨ (chunking –¥–æ–∑–≤–æ–ª—è—î –æ–±—Ä–æ–±–∏—Ç–∏)
- –ß–∞—Å –æ–±—Ä–æ–±–∫–∏: 3-4 —Å–µ–∫—É–Ω–¥–∏ (–±–µ–∑ –∑–º—ñ–Ω)
- –ü–∞–º'—è—Ç—å: +50-60 MB (–±–µ–∑ –∑–º—ñ–Ω, –∞–ª–µ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–µ)
- –ß–∞–Ω–∫—ñ–≤: ~1000 (—Å–µ–º–ø–ª—é—î—Ç—å—Å—è –¥–æ 150 –¥–ª—è –¥—É–∂–µ –≤–µ–ª–∏–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤)

---

## üîÑ –©–æ —â–µ –º–æ–∂–Ω–∞ –ø–æ–∫—Ä–∞—â–∏—Ç–∏ (–º–∞–π–±—É—Ç–Ω—î)

### –§–∞–∑–∞ 3: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –æ–±—Ä–æ–±–∫–∞
- –°—Ç–≤–æ—Ä–∏—Ç–∏ —á–µ—Ä–≥—É –æ–±—Ä–æ–±–∫–∏ (lectureQueue)
- –û–¥—Ä–∞–∑—É –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
- –û–±—Ä–æ–±–ª—è—Ç–∏ —Ñ–∞–π–ª–∏ —É —Ñ–æ–Ω—ñ
- –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å –æ–±—Ä–æ–±–∫–∏

### –§–∞–∑–∞ 4: Worker Threads
- –û–±—Ä–æ–±–∫–∞ —É –æ–∫—Ä–µ–º–æ–º—É –ø–æ—Ç–æ—Ü—ñ
- –ó–º–µ–Ω—à–µ–Ω–Ω—è –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –æ–±—Ä–æ–±–ª—è—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ñ–∞–π–ª—ñ–≤ –æ–¥–Ω–æ—á–∞—Å–Ω–æ

---

## üêõ Troubleshooting

### –ü–æ–º–∏–ª–∫–∞: "Cannot read property 'text' of undefined"
**–ü—Ä–∏—á–∏–Ω–∞:** –°—Ç–∞—Ä–∏–π –∫–æ–¥ embeddings –æ—á—ñ–∫—É—î –º–∞—Å–∏–≤ —Ä—è–¥–∫—ñ–≤, –∞ –Ω–µ –æ–±'—î–∫—Ç—ñ–≤ TextChunk

**–†—ñ—à–µ–Ω–Ω—è:** –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–Ω–æ–≤–ª–µ–Ω–∏–π embeddings.ts

### –ü–æ–º–∏–ª–∫–∞: "Column 'chunk_index' does not exist"
**–ü—Ä–∏—á–∏–Ω–∞:** –ú—ñ–≥—Ä–∞—Ü—ñ—è –ë–î –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∞

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ–Ω–∞–π—Ç–µ –º—ñ–≥—Ä–∞—Ü—ñ—é –∑ –ö—Ä–æ–∫—É 2

### Embeddings –≤—Å–µ —â–µ –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å
**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–¥ –≤—Å–µ —â–µ –∑–∞–∫–æ–º–µ–Ω—Ç–æ–≤–∞–Ω–∏–π

**–†—ñ—à–µ–Ω–Ω—è:** –í–∏–∫–æ–Ω–∞–π—Ç–µ –ö—Ä–æ–∫ 3 –¥–ª—è —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è

---

## üìù –ü—Ä–∏–º—ñ—Ç–∫–∏

- Text cleaning –ø—Ä–∞—Ü—é—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–ª—è –≤—Å—ñ—Ö –Ω–æ–≤–∏—Ö –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å
- Chunking –ø—Ä–∞—Ü—é—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ embeddings —É–≤—ñ–º–∫–Ω–µ–Ω—ñ
- –°—Ç–∞—Ä—ñ –ª–µ–∫—Ü—ñ—ó –Ω–µ –±—É–¥—É—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Ä–æ–±–ª–µ–Ω—ñ
- –î–ª—è –ø–µ—Ä–µ–æ–±—Ä–æ–±–∫–∏ —Å—Ç–∞—Ä–∏—Ö –ª–µ–∫—Ü—ñ–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ endpoint `/api/lectures/:id/reprocess`
