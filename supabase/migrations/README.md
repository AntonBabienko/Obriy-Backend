# RLS Fixes для Supabase

Цей набір міграцій виправляє проблеми з Row Level Security (RLS) політиками в Supabase.

## Проблема

Помилка `new row violates row-level security policy` виникала через те, що RLS політики не дозволяли service role (backend) виконувати операції з базою даних.

## Рішення

Оновлені RLS політики тепер дозволяють:
- **Service role** (`auth.uid() IS NULL`) - повний доступ до всіх операцій
- **Користувачі** - обмежений доступ згідно з їх ролями

## Як застосувати виправлення

### Варіант 1: Через Supabase SQL Editor (Рекомендовано)

1. Відкрийте [Supabase Dashboard](https://app.supabase.com)
2. Перейдіть до вашого проекту
3. Відкрийте **SQL Editor**
4. Скопіюйте вміст файлу `all_rls_fixes.sql`
5. Вставте в SQL Editor і натисніть **Run**

### Варіант 2: Через окремі міграції

Застосуйте міграції в такому порядку:

1. `fix_profiles_rls.sql`
2. `fix_courses_rls.sql` 
3. `fix_course_enrollments_rls.sql`

### Варіант 3: Через скрипт (Linux/Mac)

```bash
# Встановіть змінні оточення
export SUPABASE_URL="your-supabase-url"
export SUPABASE_SERVICE_KEY="your-service-key"

# Запустіть скрипт
chmod +x backend/scripts/apply-rls-fixes.sh
./backend/scripts/apply-rls-fixes.sh
```

## Що виправлено

### Таблиця `profiles`
- ✅ Service role може створювати/читати/оновлювати/видаляти профілі
- ✅ Користувачі можуть переглядати всі профілі
- ✅ Користувачі можуть оновлювати тільки свій профіль

### Таблиця `courses`
- ✅ Service role має повний доступ
- ✅ Всі можуть переглядати курси
- ✅ Викладачі можуть створювати/оновлювати/видаляти свої курси

### Таблиця `course_enrollments`
- ✅ Service role має повний доступ
- ✅ Студенти бачать тільки свої записи
- ✅ Викладачі бачать записи на свої курси
- ✅ Викладачі можуть записувати/видаляти студентів
- ✅ Студенти та викладачі можуть оновлювати прогрес

## Перевірка

Після застосування міграцій перевірте:

1. **Запис студента на курс** - має працювати без помилок
2. **Перегляд списку студентів** - викладач бачить студентів свого курсу
3. **Оновлення прогресу** - працює для студентів та викладачів

## Troubleshooting

### Помилка "policy already exists"
Це нормально - міграції використовують `DROP POLICY IF EXISTS` для безпечного оновлення.

### Помилка "permission denied"
Переконайтеся, що використовуєте **service key**, а не **anon key**.

### Помилка "auth.uid() is null"
Це очікувана поведінка для service role - політики це враховують.

## Безпека

- Service role має повний доступ - це нормально для backend операцій
- Користувачі мають обмежений доступ згідно з їх ролями
- RLS залишається увімкненим для всіх таблиць