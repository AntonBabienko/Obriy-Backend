# AI Chat Endpoint Caching - –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

## –û–≥–ª—è–¥

–£—Å–ø—ñ—à–Ω–æ —ñ–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–æ —Å–∏—Å—Ç–µ–º—É –∫–µ—à—É–≤–∞–Ω–Ω—è –≤ AI chat endpoint (`/api/ai/chat/:lectureId`).

## –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó

### 7.1 –ú–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è /api/ai/chat endpoint ‚úÖ

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
1. ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è cache key –∑ `lecture_id + user_query + content_hash`
2. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à—É –ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º Groq API
3. ‚úÖ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π —á–∞—Ç—É –≤ –∫–µ—à
4. ‚úÖ –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –∫–µ—à—É —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

**–î–µ—Ç–∞–ª—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `contentHashService.generateHash()` –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ö–µ—à—É –∫–æ–Ω—Ç–µ–Ω—Ç—É –ª–µ–∫—Ü—ñ—ó
- –ö–ª—é—á –∫–µ—à—É –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `aiCacheService.generateCacheKey()` –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
  - `operationType: 'chat'`
  - `lectureIds: [lectureId]`
  - `params: { query: message }`
  - `contentHash`
- –ü—Ä–∏ cache hit –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è:
  - `response` - –∫–µ—à–æ–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
  - `cached: true`
  - `cachedAt` - —á–∞—Å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–µ—à—É
  - `tokensSaved` - –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–æ—â–∞–¥–∂–µ–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤
- –ü—Ä–∏ cache miss:
  - –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è Groq API
  - –í—ñ–¥–ø–æ–≤—ñ–¥—å –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –∫–µ—à
  - –ü–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è `cached: false` —Ç–∞ `tokensUsed`

### 7.2 –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ forceRefresh ‚úÖ

**–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ:**
1. ‚úÖ –ü—Ä–∏–π–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `forceRefresh` –∑ —Ç—ñ–ª–∞ –∑–∞–ø–∏—Ç—É
2. ‚úÖ –û–±—Ö—ñ–¥ –∫–µ—à—É –∫–æ–ª–∏ `forceRefresh=true`
3. ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–µ—à–æ–≤–∞–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø—ñ—Å–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è

**–î–µ—Ç–∞–ª—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó:**
- –ü–∞—Ä–∞–º–µ—Ç—Ä `forceRefresh` –ø—Ä–∏–π–º–∞—î—Ç—å—Å—è –∑ `req.body` (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º `false`)
- –ö–æ–ª–∏ `forceRefresh=true`, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à—É –ø—Ä–æ–ø—É—Å–∫–∞—î—Ç—å—Å—è
- –õ–æ–≥—É—î—Ç—å—Å—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: `üîÑ FORCE REFRESH - Bypassing cache`
- –ù–æ–≤–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ API –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î –∫–µ—à —á–µ—Ä–µ–∑ `upsert`

## –õ–æ–≥—É–≤–∞–Ω–Ω—è

–†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É:

```typescript
// Cache hit
console.log('‚úÖ CACHE HIT - Returning cached chat response', {
    lectureId,
    query: message.substring(0, 50),
    tokensSaved: cached.tokens_used
});

// Cache miss
console.log('‚ùå CACHE MISS - Calling Groq API', {
    lectureId,
    query: message.substring(0, 50)
});

// Force refresh
console.log('üîÑ FORCE REFRESH - Bypassing cache', {
    lectureId,
    query: message.substring(0, 50)
});

// Cache stored
console.log('üíæ CACHE STORED - Chat response cached', {
    lectureId,
    query: message.substring(0, 50),
    tokensUsed
});
```

## –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –ó–≤–∏—á–∞–π–Ω–∏–π –∑–∞–ø–∏—Ç (–∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º)
```bash
POST /api/ai/chat/:lectureId
{
  "message": "–©–æ —Ç–∞–∫–µ React hooks?"
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å (cache hit):**
```json
{
  "response": "React hooks - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—ó...",
  "cached": true,
  "cachedAt": "2024-01-15T10:30:00Z",
  "tokensSaved": 1250
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å (cache miss):**
```json
{
  "response": "React hooks - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—ó...",
  "cached": false,
  "tokensUsed": 1250
}
```

### –ü—Ä–∏–º—É—Å–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
```bash
POST /api/ai/chat/:lectureId
{
  "message": "–©–æ —Ç–∞–∫–µ React hooks?",
  "forceRefresh": true
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
{
  "response": "React hooks - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—ó... (–Ω–æ–≤–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å)",
  "cached": false,
  "tokensUsed": 1300
}
```

## –û—Ü—ñ–Ω–∫–∞ —Ç–æ–∫–µ–Ω—ñ–≤

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –ø—Ä–∏–±–ª–∏–∑–Ω–∞ –æ—Ü—ñ–Ω–∫–∞: **1 —Ç–æ–∫–µ–Ω ‚âà 4 —Å–∏–º–≤–æ–ª–∏**

```typescript
const tokensUsed = Math.ceil(
  (context.length + message.length + (response?.length || 0)) / 4
);
```

## –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

- –ü–æ–º–∏–ª–∫–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è –ª–æ–≥—É—é—Ç—å—Å—è, –∞–ª–µ –Ω–µ –ª–∞–º–∞—é—Ç—å —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å
- –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–µ—à—É - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–≤–∏—á–∞–π–Ω–∏–π –∑–∞–ø–∏—Ç –¥–æ API
- –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –∫–µ—à - –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—Å–µ –æ–¥–Ω–æ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
- –í—Å—ñ –ø–æ–º–∏–ª–∫–∏ –ª–æ–≥—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ `console.error()`

## –í–∞–ª—ñ–¥–∞—Ü—ñ—è

- ‚úÖ TypeScript –∫–æ–º–ø—ñ–ª—è—Ü—ñ—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- ‚úÖ –ö–æ–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤–∏–º–æ–≥–∞–º Requirements 1.1, 1.2, 1.3, 5.2, 6.1, 6.2
- ‚úÖ –Ü–Ω—Ç–µ–≥—Ä–æ–≤–∞–Ω–æ –∑ —ñ—Å–Ω—É—é—á–∏–º–∏ —Å–µ—Ä–≤—ñ—Å–∞–º–∏ `aiCacheService` —Ç–∞ `contentHashService`
- ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —ñ—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—É –≤ —Ç–∞–±–ª–∏—Ü—ñ `chat_messages`

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–ó–≥—ñ–¥–Ω–æ –∑ tasks.md, –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–∞–¥–∞—á—ñ:
- Task 8: –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∫–µ—à—É–≤–∞–Ω–Ω—è –≤ summary generation endpoint
- Task 9: –î–æ–¥–∞–≤–∞–Ω–Ω—è API endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–µ—à–µ–º
- Task 10: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–µ—à—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ –∫–æ–Ω—Ç–µ–Ω—Ç—É
- Task 11: –î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤ –∫–µ—à—É —É frontend

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ó–∞–¥–∞—á–∞ 7 –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞**
- ‚úÖ 7.1 Modify /api/ai/chat endpoint
- ‚úÖ 7.2 Add forceRefresh support to chat
